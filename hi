SELECT 
    Q1.ROWNUM_MINUS_1,
    Q1.BCBSA_VBP_ID,
    Q2.PROV_MBR_SLF_ATRBTN_IND,
    Q3.AFFLTN_TYPE,
    Q3.PR_GRP
FROM (
    SELECT ROWNUM-1 AS ROWNUM_MINUS_1, VBP.PROV_RESOURCE_ID, PR.PRCTR_ROLE_ID, VBP.BCBSA_VBP_ID
    FROM PDT.WRK_PRCTR_ROLE_LCTN_XWALK PR
    INNER JOIN PDT.WRK_PRCTR_ROLE RL ON RL.PRCTR_ROLE_ID = PR.PRCTR_ROLE_ID
    INNER JOIN PDT.PROV_VBP VBP ON RL.PROV_RESOURCE_ID = VBP.PROV_RESOURCE_ID
                                  AND PR.LCTN_RESOURCE_ID = VBP.LCTN_RESOURCE_ID
                                  AND RL.NTWK_RESOURCE_ID = VBP.NTWK_RESOURCE_ID
    INNER JOIN PDT.BCBSA_PLANCD_VBP_XWALK PLV ON VBP.BCBSA_VBP_ID = PLV.VBP_ID
                                              AND SUBSTR(RL.NTWK_RESOURCE_ID,0,3) = PLV.PLAN_CD
    WHERE PR.PRCTR_ROLE_ID = '040-778e04c576623b4a925bc483e111f36e-PractitionerRole'
      AND VBP.BCBSA_VBP_ID IS NOT NULL
) Q1
INNER JOIN (
    SELECT VBP.PROV_RESOURCE_ID, PR.PRCTR_ROLE_ID, VBP.PROV_MBR_SLF_ATRBTN_IND
    FROM PDT.WRK_PRCTR_ROLE_LCTN_XWALK PR
    INNER JOIN PDT.WRK_PRCTR_ROLE RL ON RL.PRCTR_ROLE_ID = PR.PRCTR_ROLE_ID
    INNER JOIN PDT.PROV_VBP VBP ON RL.PROV_RESOURCE_ID = VBP.PROV_RESOURCE_ID
                                  AND PR.LCTN_RESOURCE_ID = VBP.LCTN_RESOURCE_ID
                                  AND RL.NTWK_RESOURCE_ID = VBP.NTWK_RESOURCE_ID
    INNER JOIN PDT.BCBSA_PLANCD_VBP_XWALK PLV ON VBP.BCBSA_VBP_ID = PLV.VBP_ID
                                              AND SUBSTR(RL.NTWK_RESOURCE_ID,0,3) = PLV.PLAN_CD
    WHERE PR.PRCTR_ROLE_ID = '040-778e04c576623b4a925bc483e111f36e-PractitionerRole'
      AND VBP.PROV_MBR_SLF_ATRBTN_IND IS NOT NULL
) Q2 ON Q1.PROV_RESOURCE_ID = Q2.PROV_RESOURCE_ID
     AND Q1.PRCTR_ROLE_ID = Q2.PRCTR_ROLE_ID
INNER JOIN (
    SELECT 
        ROWNUM-1 AS ROWNUM_MINUS_1,
        PRCTR_ROLE_ID,
        AFFLTN_TYPE,
        width_bucket(TO_NUMBER(MSTR_PROV_ID), 1, 70000, 5) AS PR_GRP
    FROM (
        SELECT DISTINCT 
            PRCTR_ROLE_ID,
            AFFLTN_TYPE,
            width_bucket(TO_NUMBER(MSTR_PROV_ID), 1, 70000, 5) AS PR_GRP
        FROM PDT.WRK_PRCTR_ROLE
        WHERE WRK_PRCTR_ROLE.ORG_RESOURCE_ID IS NOT NULL 
          AND WRK_PRCTR_ROLE.PRCTR_ROLE_ID = '040-778e04c576623b4a925bc483e111f36e-PractitionerRole'
    ) nest_tbl
) Q3 ON Q1.PRCTR_ROLE_ID = Q3.PRCTR_ROLE_ID
ORDER BY Q3.PR_GRP;
